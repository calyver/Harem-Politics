toggle_harem_window = {
    effect = {
        if = {
            limit = {
                has_variable = show_harem_window
            }
            remove_variable = show_harem_window
        }
        else = {
            set_variable = show_harem_window
        }
    }
}

update_harem_list = {
	scope = character
	
	effect = {
		#Clear the lists
		clear_variable_list = harem_ps_list
		clear_variable_list = harem_gc_list
		clear_variable_list = harem_ss_list
		clear_variable_list = harem_concubine_list
		
		if = { #Is the character married?
            limit = {
                exists = scope:harem_master
            }
			clear_saved_scope = harem_master
		}
		
		save_scope_as = harem_master
        if = { #Is the character married?
            limit = {
                is_married = yes
            }
			primary_spouse = {
				save_scope_as = harem_head
			}
			add_to_variable_list = {
				name = harem_ps_list
				target = scope:harem_head
			}
        }
		
		if = { #Can you have a Grand Consort?
			limit = {
				highest_held_title_tier >= tier_kingdom
			}
			set_variable = show_gc_window
			if = {
				limit = {
					any_consort = {
						has_court_position = grand_consort_court_position
					}
				}
				random_consort = {
					limit = {
						has_court_position = grand_consort_court_position
					}
					save_scope_as = grand_consort
				}
				add_to_variable_list = {
					name = harem_gc_list
					target = scope:grand_consort
				}
			}
        }
		
		if = { #Do you accept polygamy?
            limit = {
                accepts_polygamy = yes
            }
			set_variable = show_ss_window
			every_consort = {
				limit = {
					is_married = yes
					NOR = {
						this = root.primary_spouse
						has_court_position = grand_consort_court_position
					}
				}
				#order_by = consort_hierarchy_score
				
				save_scope_as = ss_consort
				root = {
					add_to_variable_list = {
						name = harem_ss_list
						target = scope:ss_consort
					}
				}
			}
        }
		
		if = { #Do you accept concubinage?
            limit = {
                accepts_concubinage = yes
            }
			set_variable = show_concubine_window
			every_consort = {
				limit = {
					is_concubine = yes
					NOT = {
						has_court_position = grand_consort_court_position
					}
				}
				#order_by = consort_hierarchy_score
				
				save_scope_as = concubine_consort
				root = {
					add_to_variable_list = {
						name = harem_concubine_list
						target = scope:concubine_consort
					}
				}
			}
        }
    }
}

visit_harem_gui = {
	scope = character 
	effect = {
		root = {
			random_list = {
				15 = { #Your consorts are performing
					
					trigger_event = {
						id = harem_politics.0016
						days = { 1 2 }
					}
				}
				15 = { #You're taking a walk
					
					trigger_event = {
						id = harem_politics.0020
						days = { 1 2 }
					}
				}
				15 = { #Meeting Consort Ling through Consort Chun
					
					trigger_event = {
						id = harem_politics.0009
						days = { 1 2 }
					}
				}
				15 = { #Meeting Consort Ling through Consort Jia
					
					trigger_event = {
						id = harem_politics.0010
						days = { 1 2 }
					}
				}
				15 = { #Yu disrespects Zhen Huan
					
					trigger_event = {
						id = harem_politics.0019
						days = { 1 2 }
					}
				}
			}
			add_character_flag = {
				flag = flag_visited_harem
				days = 1460
			}
		}
	}
}