## Consorts and relatives ##
is_virgin_trigger = {
	any_consort = {
		even_if_dead = yes
		count = 0
	}
	any_former_spouse = {
		even_if_dead = yes
		count = 0
	}
	any_former_concubinist = {
		count = 0
	}
	any_child = {
		even_if_dead = yes
		count = 0
	}
	NOR = {
		has_trait = pregnant
		has_trait = fornicator
		has_trait = adulterer
		has_trait = sodomite
		has_trait = rakish
		has_trait = deviant
		has_trait = incestuous
		
		has_variable = had_recent_sex_with
		has_variable = had_recent_sex
	}
	num_of_relation_lover = 0
	num_of_relation_soulmate = 0
}
harem_politics_evil_consort_trigger = {
	is_capable_adult = yes
	OR = {
		has_trait = wrathful
		has_trait = ambitious
		has_trait = vengeful
		has_trait = greedy
		has_trait = deceitful
		has_trait = arrogant
		has_trait = arbitrary
		has_trait = paranoid
		has_trait = callous
		has_trait = sadistic
	}
	NOR = {
		has_trait = forgiving
		has_trait = compassionate
		has_trait = just
		has_trait = honest
	}
}
is_valid_harem_member_trigger = {
	is_adult = yes
	is_physically_able = yes
	court_owner ?= {
		this = $LIEGE$
	}
	trigger_if = {
		limit = {
			NOT = {
				is_consort_of = $LIEGE$
			}
		}
		$LIEGE$.religion = religion:islam_religion
		is_valid_muslim_harem_relative_trigger = {
			LIEGE = $LIEGE$
		}
	}
	trigger_else = {
		is_consort_of = $LIEGE$
	}
}
is_valid_muslim_harem_relative_trigger = {
	# Not married
	is_married = no
	# Check the legitimacy of the family line
	OR = {
		# Grandparents
		AND = {
			is_grandparent_of = $LIEGE$
			trigger_if = {
				limit = {
					$LIEGE$.faith = {
						NOT = { has_doctrine = doctrine_gender_equal }
					}
				}
				any_child = {
					is_parent_of = $LIEGE$
					trigger_if = {
						limit = {
							$LIEGE$.faith = {
								has_doctrine = doctrine_gender_male_dominated
							}
						}
						is_male = yes
					}
					trigger_else = {
						is_male = no
					}
				}
			}
		}
		# The mother/father
		is_parent_of = $LIEGE$
		AND = { # Aunts/uncles
			is_uncle_or_aunt_of = $LIEGE$
			any_sibling = {
				#Check sex based on religious doctrines
				trigger_if = {
					limit = {
						$LIEGE$.faith = {
							NOT = { has_doctrine = doctrine_gender_equal }
						}
					}
					trigger_if = {
						limit = {
							$LIEGE$.faith = {
								has_doctrine = doctrine_gender_male_dominated
							}
						}
						is_male = yes
					}
					trigger_else = {
						is_male = no
					}
				}
				is_parent_of = $LIEGE$
			}
		}
		# Siblings
		is_sibling_of = $LIEGE$
	}
	# Check their gender based on religious doctrines
	trigger_if = {
		limit = {
			$LIEGE$.faith = {
				NOT = { has_doctrine = doctrine_gender_equal }
			}
		}
		trigger_if = {
			limit = {
				$LIEGE$.faith = {
					has_doctrine = doctrine_gender_male_dominated
				}
			}
			is_male = no
		}
		trigger_else_if = {
			limit = {
				$LIEGE$.faith = {
					has_doctrine = doctrine_gender_female_dominated
				}
			}
			is_male = yes
		}
		trigger_else = {
			always = no
		}
	}
}
## Ranks ##
calyver_rank_is_superior_trigger = {
	$AUTHORITY$ = {
		OR = {
			#Liege's parent
			is_parent_of = $HAREM_LIEGE$
			#The PS
			AND = {
				exists = $HAREM_LIEGE$.primary_spouse
				this = $HAREM_LIEGE$.primary_spouse
			}
			#The GC
			AND = {
				has_court_position = grand_consort_court_position
				$TARGET_CONSORT$ = {
					trigger_if = {
						limit = {
							exists = $HAREM_LIEGE$.primary_spouse
						}
						NOT = {
							this = $HAREM_LIEGE$.primary_spouse
						}
					}
				}
			}
			#Spouses
			AND = {
				is_spouse_of = $HAREM_LIEGE$
				$TARGET_CONSORT$ = {
					is_concubine_of = $HAREM_LIEGE$
				}
			}
		}
	}
	$TARGET_CONSORT$ = {
		is_consort_of = $HAREM_LIEGE$
		NOT = {
			is_parent_of = $HAREM_LIEGE$
		}
	}
}
is_head_of_the_harem_trigger = {
	is_healthy = yes
	is_valid_harem_member_trigger = {
		LIEGE = $LIEGE$
	}
	NOT = {
		is_regular_concubine_of = {
			LIEGE = $LIEGE$
		}
	}
	# Single hierarchy - only one condition should be true
	trigger_if = { #Liege's mother is always the head of the harem
		limit = {
			$LIEGE$ = {
				religion = religion:islam_religion
				any_parent = {
					is_courtier_of = $LIEGE$
					is_valid_harem_member_trigger = {
						LIEGE = $LIEGE$
					}
					NOT = { is_consort_of = $LIEGE$ }
				}
			}
		}
		is_parent_of = $LIEGE$
	}
	trigger_else_if = { #Grandparents
		limit = {
			$LIEGE$ = {
				religion = religion:islam_religion
				any_courtier = {
					is_grandparent_of = $LIEGE$
					is_valid_harem_member_trigger = {
						LIEGE = $LIEGE$
					}
					NOT = { is_consort_of = $LIEGE$ }
				}
			}
		}
		is_grandparent_of = $LIEGE$
	}
	trigger_else_if = { #Unmarried paternal aunt
		limit = {
			$LIEGE$ = {
				religion = religion:islam_religion
				any_parent = {
					any_sibling = {
						is_courtier_of = $LIEGE$
						is_valid_harem_member_trigger = {
							LIEGE = $LIEGE$
						}
						NOT = { is_consort_of = $LIEGE$ }
					}
				}
			}
		}
		is_uncle_or_aunt_of = $LIEGE$
	}
	trigger_else_if = { #Unmarried older sisters
		limit = {
			$LIEGE$ = {
				religion = religion:islam_religion
				any_sibling = {
					age > $LIEGE$.age
					is_courtier_of = $LIEGE$
					is_valid_harem_member_trigger = {
						LIEGE = $LIEGE$
					}
					NOT = { is_consort_of = $LIEGE$ }
				}
			}
		}
		age > $LIEGE$.age
		is_sibling_of = $LIEGE$
	}

	trigger_else_if = { #The primary spouse
		limit = {
			$LIEGE$.primary_spouse ?= {
				is_courtier_of = $LIEGE$
			}
		}
		this = $LIEGE$.primary_spouse
	}
	trigger_else_if = { #The grand consort
		limit = {
			$LIEGE$ = {
				employs_court_position = grand_consort_court_position
			}
		}
		has_court_position = grand_consort_court_position
	}
	trigger_else_if = { #Just any spouse
		limit = {
			$LIEGE$ = {
				any_spouse = {
					is_courtier_of = $LIEGE$
				}
			}
		}
		is_spouse_of = $LIEGE$
	}
	trigger_else = { #Younger sisters
		limit = {
			$LIEGE$ = {
				religion = religion:islam_religion
				any_sibling = {
					is_courtier_of = $LIEGE$
					is_valid_harem_member_trigger = {
						LIEGE = $LIEGE$
					}
					NOT = { is_consort_of = $LIEGE$ }
				}
			}
		}
		is_sibling_of = $LIEGE$
	}
}
is_grand_consort_trigger = {
	has_court_position = grand_consort_court_position
}
# The Four Consorts
is_pure_consort_trigger = {
	OR = {
		has_character_modifier = pure_consort_modifier
		has_character_modifier = pure_lord_modifier
	}
	has_opinion_modifier = {
		modifier = appointed_as_special_consort
		target = $HAREM_LIEGE$
	}
}
is_virtuous_consort_trigger = {
	OR = {
		has_character_modifier = virtuous_consort_modifier
		has_character_modifier = virtuous_lord_modifier
	}
	has_opinion_modifier = {
		modifier = appointed_as_special_consort
		target = $HAREM_LIEGE$
	}
}
is_worthy_consort_trigger = {
	OR = {
		has_character_modifier = worthy_consort_modifier
		has_character_modifier = worthy_lord_modifier
	}
	has_opinion_modifier = {
		modifier = appointed_as_special_consort
		target = $HAREM_LIEGE$
	}
}
is_imperial_consort_trigger = {
	OR = {
		has_character_modifier = imperial_consort_modifier
		has_character_modifier = imperial_lord_modifier
	}
	has_opinion_modifier = {
		modifier = appointed_as_special_consort
		target = $HAREM_LIEGE$
	}
}
is_ranked_consort_trigger = {
	OR = {
		is_grand_consort_trigger = yes
		is_pure_consort_trigger = {
			HAREM_LIEGE = $HAREM_LIEGE$
		}
		is_virtuous_consort_trigger = {
			HAREM_LIEGE = $HAREM_LIEGE$
		}
		is_worthy_consort_trigger = {
			HAREM_LIEGE = $HAREM_LIEGE$
		}
		is_imperial_consort_trigger = {
			HAREM_LIEGE = $HAREM_LIEGE$
		}
	}
	is_consort_of = $HAREM_LIEGE$
	court_owner ?= {
		this = $HAREM_LIEGE$
		can_appoint_char_as_ranked_consort_trigger = yes
	}
	trigger_if = {
		limit = {
			exists = $HAREM_LIEGE$.primary_spouse
		}
		this != $HAREM_LIEGE$.primary_spouse
	}
}
is_secondary_spouse_trigger = {
	is_married = yes
	save_temporary_scope_as = harem_spouse
	NOR = {
		has_court_position = grand_consort_court_position 
		any_spouse = {
			primary_spouse ?= {
				this = scope:harem_spouse
			}
		}
	}
}
is_regular_concubine_of = {
	is_concubine_of = $LIEGE$
	NOT = {
		is_ranked_consort_trigger = {
			HAREM_LIEGE = $LIEGE$
		}
	}
}

# Can be replaced? #
is_childless_aged_concubine_trigger = {
	is_ai = yes
	is_designated_diarch = no
	OR = {
		AND = {
			is_female = yes
			age > define:NChildbirth|MAX_FEMALE_REPRODUCTION_AGE
		}
		AND = {
			is_male = yes
			age > define:NCharacter|MALE_ATTRACTION_CUTOFF_AGE
		}
	}
	is_regular_concubine_of = {
		HAREM_LIEGE = scope:liege
	}
	harem_politics_favored_consort_trigger = no # Can't be favored
	any_child = {
		is_child_of = scope:liege
		count = 0
	}
	NOR = {
		has_relation_best_friend = scope:liege
		has_relation_friend = scope:liege
		has_relation_lover = scope:liege
		has_relation_soulmate = scope:liege
	}
}

## Demoted or Divorced ##
is_demoted_consort_trigger = {
	OR = {
		has_character_modifier = demoted_spouse_modifier
		has_character_modifier = demoted_primary_spouse_modifier
	}
}
has_demoted_or_divorced_opinion_trigger = {
	OR = {
		has_demoted_or_divorced_as_ps_opinion_trigger = {
			TARGET = $TARGET$
		}

		has_opinion_modifier = {
			target = $TARGET$
			modifier = divorced_me_as_gc
		}
		has_opinion_modifier = {
			target = $TARGET$
			modifier = divorced_me_as_ss
		}

		has_opinion_modifier = {
			target = $TARGET$
			modifier = demoted_me_as_gc
		}
		has_opinion_modifier = {
			target = $TARGET$
			modifier = demoted_me_as_ss
		}

		has_opinion_modifier = {
			modifier = dismissed_me_as_gc
			target = $TARGET$
		}
		has_opinion_modifier = {
			modifier = dismissed_me_as_ss
			target = $TARGET$
		}
	}
}
has_demoted_or_divorced_as_ps_opinion_trigger = {
	OR = {
		has_opinion_modifier = {
			target = $TARGET$
			modifier = divorced_me_as_ps
		}

		has_opinion_modifier = {
			target = $TARGET$
			modifier = demoted_me_as_ps
		}

		has_opinion_modifier = {
			modifier = dismissed_me_as_ps
			target = $TARGET$
		}
	}
}
has_divorced_opinion_trigger = {
	OR = {
		has_opinion_modifier = {
			target = $TARGET$
			modifier = divorced_me_as_ps
		}
		has_opinion_modifier = {
			target = $TARGET$
			modifier = divorced_me_as_gc
		}
		has_opinion_modifier = {
			target = $TARGET$
			modifier = divorced_me_as_ss
		}
	}
}

## Cultural/Religious Acceptance ##
hp_accepts_polygamy = {
	custom_tooltip = {
		text = hp_accepts_polygamy_tooltip
		OR = {
			faith = { has_doctrine_parameter = allows_polygamy }
			culture = { has_cultural_parameter = allows_polygamy }  
		}
		NOT = {
			culture = {
				has_cultural_parameter = blocks_polygamy
			}
		}
	}
}
hp_accepts_concubinage = {
	custom_tooltip = {
		text = hp_accepts_concubinage_tooltip
		OR = {
			faith = { has_doctrine_parameter = allows_concubinage }
			culture = { has_cultural_parameter = allows_concubinage }
		}
		NOT = {
			culture = {
				has_cultural_parameter = blocks_concubinage
			}
		}
	}
}
hp_accepts_harems = {
	OR = {
		hp_accepts_polygamy = yes
		hp_accepts_concubinage = yes
	}
}

## Liege Conditions ##
can_be_visited_trigger = {
	NOR = {
		has_character_flag = is_visiting_harem_character_flag
		has_character_flag = is_being_visited_harem_character_flag
	}
}
can_have_imperial_consorts_trigger = {
	highest_held_title_tier >= tier_kingdom
	can_have_settled_harem_trigger = yes
	custom_tooltip = {
		text = sovereign_of_realm_tooltip
		trigger_if = {
			limit = {
				government_allows = administrative
			}
			is_independent_ruler = yes
		}
	}
}
can_have_settled_harem_trigger = {
	custom_tooltip = {
		text = your_government_is_settled_tooltip
		NOR = {
			government_has_flag = government_is_tribal
			government_has_flag = government_is_nomadic
			government_has_flag = government_is_herder
			government_has_flag = government_is_landless_adventurer
		}
	}
}
has_unsettled_government_trigger = {
	OR = {
		government_has_flag = government_is_tribal
		government_has_flag = government_is_nomadic
		government_has_flag = government_is_herder
		government_has_flag = government_is_landless_adventurer
	}
}
can_appoint_char_as_ranked_consort_trigger = {
	can_have_imperial_consorts_trigger = yes
	highest_held_title_tier >= tier_empire
}
has_four_consorts_limit_trigger = {
	any_consort = {
		OR = {
			is_grand_consort_trigger = yes
			is_pure_consort_trigger = {
				HAREM_LIEGE = $HAREM_LIEGE$
			}
			is_virtuous_consort_trigger = {
				HAREM_LIEGE = $HAREM_LIEGE$
			}
			is_worthy_consort_trigger = {
				HAREM_LIEGE = $HAREM_LIEGE$
			}
		}
		count = 4
	}
}

# Children
is_bastard_child_trigger = {
	OR = {
		has_any_bastard_trait_trigger = yes
		has_trait = bastard_founder
	}
}

